#
# Meadow.Daemon Configuration File Example
#
# This is a template configuration file for the Meadow daemon.
# Copy this to /etc/meadow.conf or specify with MEADOW_CONFIG environment variable.
#
# All settings have sensible defaults. Lines starting with # are comments.
#

# ============================================================================
# SERVICE SETTINGS
# ============================================================================

# Enable or disable the Meadow daemon cloud connection
# Values: yes, no
# Default: yes
enabled yes

# Enable or disable the MQTT listener for cloud-based update notifications
# When set to 'yes', the daemon will:
#   - Connect to the MQTT broker
#   - Subscribe to update topics
#   - Receive and store update notifications
#   - Optionally auto-download updates (if auto_download_updates is enabled)
# When set to 'no', the daemon will:
#   - Only run the REST API server
#   - Rely on external applications to handle MQTT subscriptions and downloads
#   - Still provide update apply functionality via REST API
# Values: yes, no
# Default: yes (for backward compatibility)
# Use case: Set to 'no' if you have a separate application managing update notifications
enable_mqtt_listener no

# ============================================================================
# PATH SETTINGS
# ============================================================================

# Root directory where the application runs from
# Updates are applied to this directory
# Default: /opt/meadow
# Environment variable: MEADOW_ROOT (overrides this setting)
meadow_root /opt/meadow

# Root directory for all temporary daemon operations
# This setting controls where downloads, extractions, and staging occur
# Default: /tmp/meadow
# Environment variable: MEADOW_TEMP (overrides this setting)
#
# When you set meadow_temp, the following paths are automatically derived:
#   - update_store_path: {meadow_temp}/updates     (MPAK storage)
#   - temp_extract_path: {meadow_temp}/update      (MPAK extraction)
#   - staging_path:      {meadow_temp}/staging     (Update staging)
#   - rollback_path:     {meadow_temp}/rollback    (Update rollback)
#
# You can override individual paths if needed using UPDATE_STORE_PATH or
# TEMP_EXTRACT_PATH environment variables.
meadow_temp /tmp/meadow

# ============================================================================
# REST API SETTINGS
# ============================================================================

# Bind address for the REST API server
# The daemon's REST API listens on port 5000 for update management commands
# Use 127.0.0.1 for localhost-only access (production/secure)
# Use 0.0.0.0 to allow remote connections (development/testing)
# Default: 127.0.0.1 (localhost only for security)
# Security Warning: Using 0.0.0.0 allows any device on your network to access
#                   the daemon's REST API. Only use for development/testing.
rest_api_bind_address 0.0.0.0

# ============================================================================
# UPDATE SERVER SETTINGS (MQTT)
# ============================================================================

# Address of the Update/MQTT server
# For Meadow.Cloud public server: tcp://mqtt.meadowcloud.co
# For local development (WSL): tcp://172.26.0.1
# For localhost: tcp://localhost
update_server_address tcp://mqtt.meadowcloud.co

# Port of the Update/MQTT server
# Default: 1883 (standard MQTT port)
# Secure MQTT: 8883
update_server_port 1883

# ============================================================================
# AUTHENTICATION SETTINGS
# ============================================================================

# Use authentication when connecting to the Update server
# Set to 'yes' for Meadow.Cloud, 'no' for local development
# Default: yes
use_authentication yes

# Address of the authentication server
# Default: https://www.meadowcloud.co
auth_server_address https://www.meadowcloud.co

# Port of the authentication server
# Default: 443 (HTTPS)
auth_server_port 443

# Maximum number of authentication retry attempts before giving up
# The daemon will retry authentication with exponential backoff (5s, 10s, 15s... up to 60s)
# After reaching this limit, the daemon enters AuthenticationFailed state
# Set to 0 to retry indefinitely (not recommended)
# Default: 10
# Recommended range: 5-20
auth_max_retries 10

# Path to SSH private key for authentication
# The public key is expected to be at the same path with '.pub' appended
# Default: ~/.ssh/id_rsa (uses the current user's HOME directory)
# Example for custom location: /home/myuser/.ssh/meadow_rsa
# Note: The daemon will automatically use $HOME/.ssh/id_rsa if this is not set
#ssh_key_path /home/myuser/.ssh/id_rsa

# ============================================================================
# MQTT TOPIC SETTINGS
# ============================================================================

# MQTT topics to listen to for update notifications
# Supports macro substitution:
#   {ID}  - Device's unique machine ID
#   {OID} - Organization ID from JWT token
# Multiple topics separated by semicolon
# Default: {OID}/ota/{ID}
# Example: ota;ota/{ID}/updates;{OID}/ota/{ID}
mqtt_topics {OID}/ota/{ID}

# Automatically download update packages when published via MQTT
# When set to 'yes', the daemon will automatically download update packages
# immediately after receiving update notifications, without requiring a manual
# REST API download call. The download blocks the state machine for 1-5 seconds.
# When set to 'no', updates must be downloaded manually via REST API.
# Values: yes, no
# Default: no (backward compatibility)
auto_download_updates no

# ============================================================================
# TIMING SETTINGS
# ============================================================================

# Retry interval when disconnected from Update server (in seconds)
# The daemon will wait this long between reconnection attempts
# Default: 15
connect_retry_seconds 15

# Timeout to wait for application to exit during update apply (in seconds)
# If the application doesn't exit within this time, update is marked as failed
# Default: 300 (5 minutes)
# Recommended range: 60-600
update_apply_timeout_seconds 300

# ============================================================================
# APPLICATION RESTART SETTINGS
# ============================================================================

# Is the application managed by systemd?
# When set to 'yes', the daemon will use 'systemctl stop/start' to restart the app
# This prevents race conditions where systemd auto-restarts the app during update
# When set to 'no', the daemon will spawn the process directly after update
# Values: yes, no
# Default: no
# Note: If 'yes', you must also specify app_service_name below
app_is_systemd_service no

# Systemd service name (required if app_is_systemd_service is 'yes')
# The daemon will run 'systemctl stop <name>' before update and 'systemctl start <name>' after
# Example: meadow-app.service
# Default: (empty - must be set if app_is_systemd_service is 'yes')
# Security: Daemon must have permission to control this service (may require sudo/polkit setup)
#app_service_name meadow-app.service

# ============================================================================
# NOTES
# ============================================================================
#
# Environment Variables:
#   MEADOW_ROOT        - Overrides meadow_root setting (where app runs)
#   MEADOW_TEMP        - Overrides meadow_temp setting (temp operations root)
#                        Setting this auto-derives: updates/, update/, staging/, rollback/
#   UPDATE_STORE_PATH  - Overrides derived update_store_path
#   TEMP_EXTRACT_PATH  - Overrides derived temp_extract_path
#   MEADOW_CONFIG      - Specifies config file location (default: /etc/meadow.conf)
#
# Directory Structure:
#   MEADOW_ROOT (default: /opt/meadow)
#     └── Application files (where updates are applied)
#
#   MEADOW_TEMP (default: /tmp/meadow)
#     ├── updates/       - Downloaded MPAK files organized by ID
#     ├── update/        - Extracted MPAK contents before applying
#     ├── staging/       - Staged files before atomic swap
#     └── rollback/      - Backup of previous version
#
# REST API:
#   The daemon always runs a REST API server on port 5000 (regardless of enable_mqtt_listener)
#   Endpoints:
#     GET  /api/info              - Get daemon information
#     GET  /api/updates           - List available updates
#     PUT  /api/updates/{id}      - Download or apply update
#     PUT  /api/apply             - Apply already-extracted update
#     DELETE /api/updates         - Clear update store
#     GET  /api/files[/{path}]    - List files in meadow_root
#
# Operating Modes:
#   1. Full mode (enable_mqtt_listener=yes):
#      - Daemon handles MQTT subscriptions, downloads, and applies updates
#      - REST API available for external control and monitoring
#
#   2. REST-only mode (enable_mqtt_listener=no):
#      - External application handles MQTT subscriptions and downloads
#      - Daemon provides REST API for applying updates and file operations
#      - Use PUT /api/apply after extracting updates to temp_extract_path
#
# For more information, see:
#   https://github.com/WildernessLabs/Meadow.Daemon
#
